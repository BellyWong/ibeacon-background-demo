#Extending Background Ranging Time 

Hypothesis:  An app can use `beginBackgroundTaskWithName:expirationHandler:` to get extra background ranging time on iOS8.

Setup:  See code in BDAppDelegate.m which requests extra background running time on entering the background and beacon region transitions.  This code contains a flag called self_terminate for various testing conditions.


##Test 1

For the following test, I ran, app with self_terminate=YES, causing the background task to stop when a few seconds are remaining
put app in background by pressing home shortly after starting.

```
2014-10-14 13:49:25.594 BackgroundDemo[341:37691] 2014-10-14 17:49:25 +0000 applicationDidFinishLaunching
2014-10-14 13:49:25.893 BackgroundDemo[341:37691] 2014-10-14 17:49:25 +0000 applicationDidBecomeActive
2014-10-14 13:49:26.686 BackgroundDemo[341:37691] locationManager didDetermineState INSIDE for region1
2014-10-14 13:49:26.687 BackgroundDemo[341:37691] 2014-10-14 17:49:26 +0000 locationManager didDetermineState INSIDE for region1
2014-10-14 13:49:26.690 BackgroundDemo[341:37691] 2014-10-14 17:49:26 +0000 locationManager didRangeBeacons
2014-10-14 13:49:27.692 BackgroundDemo[341:37691] 2014-10-14 17:49:27 +0000 locationManager didRangeBeacons
2014-10-14 13:49:28.684 BackgroundDemo[341:37691] 2014-10-14 17:49:28 +0000 locationManager didRangeBeacons
2014-10-14 13:49:29.689 BackgroundDemo[341:37691] 2014-10-14 17:49:29 +0000 locationManager didRangeBeacons
2014-10-14 13:49:30.687 BackgroundDemo[341:37691] 2014-10-14 17:49:30 +0000 locationManager didRangeBeacons
2014-10-14 13:49:31.685 BackgroundDemo[341:37691] 2014-10-14 17:49:31 +0000 locationManager didRangeBeacons
2014-10-14 13:49:32.690 BackgroundDemo[341:37691] 2014-10-14 17:49:32 +0000 locationManager didRangeBeacons
2014-10-14 13:49:33.124 BackgroundDemo[341:37691] 2014-10-14 17:49:33 +0000 applicationWillResignActive
2014-10-14 13:49:33.690 BackgroundDemo[341:37691] 2014-10-14 17:49:33 +0000 locationManager didRangeBeacons
2014-10-14 13:49:33.808 BackgroundDemo[341:37691] 2014-10-14 17:49:33 +0000 applicationDidEnterBackground
2014-10-14 13:49:33.814 BackgroundDemo[341:37703] Background task started
2014-10-14 13:49:33.839 BackgroundDemo[341:37703] background time remaining:   179.97
2014-10-14 13:49:34.846 BackgroundDemo[341:37703] background time remaining:   178.97
2014-10-14 13:49:34.867 BackgroundDemo[341:37691] 2014-10-14 17:49:34 +0000 locationManager didRangeBeacons
2014-10-14 13:49:35.687 BackgroundDemo[341:37691] 2014-10-14 17:49:35 +0000 locationManager didRangeBeacons
2014-10-14 13:49:35.856 BackgroundDemo[341:37703] background time remaining:   177.96
2014-10-14 13:49:36.684 BackgroundDemo[341:37691] 2014-10-14 17:49:36 +0000 locationManager didRangeBeacons
2014-10-14 13:49:36.957 BackgroundDemo[341:37703] background time remaining:   176.86
2014-10-14 13:49:37.687 BackgroundDemo[341:37691] 2014-10-14 17:49:37 +0000 locationManager didRangeBeacons
2014-10-14 13:49:38.059 BackgroundDemo[341:37703] background time remaining:   175.75
2014-10-14 13:49:38.690 BackgroundDemo[341:37691] 2014-10-14 17:49:38 +0000 locationManager didRangeBeacons
2014-10-14 13:49:39.158 BackgroundDemo[341:37703] background time remaining:   174.66
2014-10-14 13:49:39.690 BackgroundDemo[341:37691] 2014-10-14 17:49:39 +0000 locationManager didRangeBeacons
2014-10-14 13:49:40.206 BackgroundDemo[341:37703] background time remaining:   173.61
2014-10-14 13:49:40.687 BackgroundDemo[341:37691] 2014-10-14 17:49:40 +0000 locationManager didRangeBeacons
...
2014-10-14 13:52:27.692 BackgroundDemo[341:37691] 2014-10-14 17:52:27 +0000 locationManager didRangeBeacons
2014-10-14 13:52:27.889 BackgroundDemo[341:37703] background time remaining:     5.92
2014-10-14 13:52:28.688 BackgroundDemo[341:37691] 2014-10-14 17:52:28 +0000 locationManager didRangeBeacons
2014-10-14 13:52:28.967 BackgroundDemo[341:37703] background time remaining:     4.85
2014-10-14 13:52:29.688 BackgroundDemo[341:37691] 2014-10-14 17:52:29 +0000 locationManager didRangeBeacons
2014-10-14 13:52:29.812 BackgroundDemo[341:37691] Background task expired by iOS
```

#Test 2

I ran, app with self_terminate=NO, meaning the background task kept running until the OS killed it.  I put app in background by pressing home shortly after starting

```
2014-10-14 13:55:23.441 BackgroundDemo[352:39238] 2014-10-14 17:55:23 +0000 applicationDidFinishLaunching
2014-10-14 13:55:23.728 BackgroundDemo[352:39238] 2014-10-14 17:55:23 +0000 applicationDidBecomeActive
2014-10-14 13:55:24.539 BackgroundDemo[352:39238] locationManager didDetermineState INSIDE for region1
2014-10-14 13:55:24.540 BackgroundDemo[352:39238] 2014-10-14 17:55:24 +0000 locationManager didDetermineState INSIDE for region1
2014-10-14 13:55:24.542 BackgroundDemo[352:39238] 2014-10-14 17:55:24 +0000 locationManager didRangeBeacons
2014-10-14 13:55:25.542 BackgroundDemo[352:39238] 2014-10-14 17:55:25 +0000 locationManager didRangeBeacons
2014-10-14 13:55:26.364 BackgroundDemo[352:39238] 2014-10-14 17:55:26 +0000 applicationWillResignActive
2014-10-14 13:55:26.538 BackgroundDemo[352:39238] 2014-10-14 17:55:26 +0000 locationManager didRangeBeacons
2014-10-14 13:55:27.050 BackgroundDemo[352:39238] 2014-10-14 17:55:27 +0000 applicationDidEnterBackground
2014-10-14 13:55:27.061 BackgroundDemo[352:39261] Background task started
2014-10-14 13:55:27.076 BackgroundDemo[352:39261] background time remaining:     9.99
2014-10-14 13:55:28.083 BackgroundDemo[352:39261] background time remaining:   178.99
2014-10-14 13:55:28.125 BackgroundDemo[352:39238] 2014-10-14 17:55:28 +0000 locationManager didRangeBeacons
2014-10-14 13:55:28.534 BackgroundDemo[352:39238] 2014-10-14 17:55:28 +0000 locationManager didRangeBeacons
2014-10-14 13:55:29.094 BackgroundDemo[352:39261] background time remaining:   177.98
...
2014-10-14 13:58:23.534 BackgroundDemo[352:39238] 2014-10-14 17:58:23 +0000 locationManager didRangeBeacons
2014-10-14 13:58:24.302 BackgroundDemo[352:39261] background time remaining:     2.77
2014-10-14 13:58:24.541 BackgroundDemo[352:39238] 2014-10-14 17:58:24 +0000 locationManager didRangeBeacons
2014-10-14 13:58:25.384 BackgroundDemo[352:39261] background time remaining:     1.69
2014-10-14 13:58:25.541 BackgroundDemo[352:39238] 2014-10-14 17:58:25 +0000 locationManager didRangeBeacons
2014-10-14 13:58:26.442 BackgroundDemo[352:39261] background time remaining:     0.63
2014-10-14 13:58:26.536 BackgroundDemo[352:39238] 2014-10-14 17:58:26 +0000 locationManager didRangeBeacons
2014-10-14 13:58:27.541 BackgroundDemo[352:39238] 2014-10-14 17:58:27 +0000 locationManager didRangeBeacons
2014-10-14 13:58:27.545 BackgroundDemo[352:39261] background time remaining:     0.00
2014-10-14 13:58:28.538 BackgroundDemo[352:39238] 2014-10-14 17:58:28 +0000 locationManager didRangeBeacons
2014-10-14 13:58:28.643 BackgroundDemo[352:39261] background time remaining:     0.00
...


#Test 3

Note that in the above test, that the background thread (and ranging in the background, continued indefinitely,  even after the background time remaining reached zero!)  On further inspection, it seems this only happens if connected to an XCode console via USB.  When I repeated the above test without the tether, waited five minutes, then reconnected, I saw the following in the XCode console for the same device:

```
...
Oct 14 15:10:26 Betty BackgroundDemo[352] <Warning>: background time remaining:     1.86
Oct 14 15:10:27 Betty BackgroundDemo[352] <Warning>: 2014-10-14 19:10:27 +0000 locationManager didRangeBeacons
Oct 14 15:10:27 Betty BackgroundDemo[352] <Warning>: background time remaining:     1.12
Oct 14 15:10:27 Betty BackgroundDemo[352] <Warning>: background time remaining:     0.85
Oct 14 15:10:28 Betty BackgroundDemo[352] <Warning>: 2014-10-14 19:10:28 +0000 locationManager didRangeBeacons
Oct 14 15:10:28 Betty BackgroundDemo[352] <Warning>: background time remaining:     0.04
Oct 14 15:10:28 Betty BackgroundDemo[352] <Warning>: background time remaining:     0.00
Oct 14 15:10:29 Betty assertiond[57] <Warning>: <BKNewProcess: 0x1567ddb0; com.radiusnetworks.BackgroundDemo; pid: 352> has active assertions beyond permitted time: 
{(
<BKProcessAssertion: 0x15680520> id: 352-42B64536-BE2A-401F-BF3D-8263179CCB0E name: DummyTask process: <BKNewProcess: 0x1567ddb0; com.radiusnetworks.BackgroundDemo; pid: 352> permittedBackgroundDuration: 180.000000 reason: finishTask owner pid:352 preventSuspend  preventIdleSleep  preventSuspendOnSleep ,
<BKProcessAssertion: 0x15582360> id: 352-1C7CEB10-0616-470F-B1C4-1FC38A1C2645 name: DummyTask process: <BKNewProcess: 0x1567ddb0; com.radiusnetworks.BackgroundDemo; pid: 352> permittedBackgroundDuration: 180.000000 reason: finishTask owner pid:352 preventSuspend  preventIdleSleep  preventSuspendOnSleep 
)}
Oct 14 15:10:29 Betty assertiond[57] <Warning>: Forcing crash report of <BKNewProcess: 0x1567ddb0; com.radiusnetworks.BackgroundDemo; pid: 352>...
Oct 14 15:10:29 Betty ReportCrash[400] <Error>: task_set_exception_ports(B07, 400, D03, 0, 0) failed with error (4: (os/kern) invalid argument)
Oct 14 15:10:29 Betty assertiond[57] <Warning>: Finished crash reporting.
```

#Test 4

Now we let the 180 seconds time out, then trigger a beacon region transition and request the extra background time from the didDetermineStateMethod

```
...
2014-10-14 14:20:34.663 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:34.681 BackgroundDemo[465:63710] locationManager didDetermineState INSIDE for region1
2014-10-14 14:20:34.683 BackgroundDemo[465:63710] 2014-10-14 20:20:34 +0000 locationManager didDetermineState INSIDE for region1
2014-10-14 14:20:34.687 BackgroundDemo[465:63710] Attempting to extend background running time
2014-10-14 14:20:34.691 BackgroundDemo[465:66674] Background task started
2014-10-14 14:20:34.715 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:35.624 BackgroundDemo[465:63710] 2014-10-14 20:20:35 +0000 locationManager didRangeBeacons
2014-10-14 14:20:35.746 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:35.773 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:36.623 BackgroundDemo[465:63710] 2014-10-14 20:20:36 +0000 locationManager didRangeBeacons
2014-10-14 14:20:36.844 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:36.876 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:37.623 BackgroundDemo[465:63710] 2014-10-14 20:20:37 +0000 locationManager didRangeBeacons
2014-10-14 14:20:37.947 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:37.975 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:38.628 BackgroundDemo[465:63710] 2014-10-14 20:20:38 +0000 locationManager didRangeBeacons
2014-10-14 14:20:39.032 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:39.052 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:39.622 BackgroundDemo[465:63710] 2014-10-14 20:20:39 +0000 locationManager didRangeBeacons
2014-10-14 14:20:40.061 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:40.153 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:40.626 BackgroundDemo[465:63710] 2014-10-14 20:20:40 +0000 locationManager didRangeBeacons
2014-10-14 14:20:41.155 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:41.246 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:41.620 BackgroundDemo[465:63710] 2014-10-14 20:20:41 +0000 locationManager didRangeBeacons
2014-10-14 14:20:42.248 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:42.352 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:42.623 BackgroundDemo[465:63710] 2014-10-14 20:20:42 +0000 locationManager didRangeBeacons
2014-10-14 14:20:43.350 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:43.451 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:43.623 BackgroundDemo[465:63710] 2014-10-14 20:20:43 +0000 locationManager didRangeBeacons
2014-10-14 14:20:44.446 BackgroundDemo[465:63778] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:44.549 BackgroundDemo[465:66674] background time remaining: 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.00
2014-10-14 14:20:44.625 BackgroundDemo[465:63710] 2014-10-14 20:20:44 +0000 locationManager didRangeBeacons
2014-10-14 14:20:45.553 BackgroundDemo[465:63778] background time remaining:   179.10
2014-10-14 14:20:45.627 BackgroundDemo[465:63710] 2014-10-14 20:20:45 +0000 locationManager didRangeBeacons
2014-10-14 14:20:45.655 BackgroundDemo[465:66674] background time remaining:   179.00
2014-10-14 14:20:46.620 BackgroundDemo[465:63710] 2014-10-14 20:20:46 +0000 locationManager didRangeBeacons
2014-10-14 14:20:46.664 BackgroundDemo[465:63778] background time remaining:   177.99
2014-10-14 14:20:46.774 BackgroundDemo[465:66674] background time remaining:   177.88
2014-10-14 14:20:47.620 BackgroundDemo[465:63710] 2014-10-14 20:20:47 +0000 locationManager didRangeBeacons
2014-10-14 14:20:47.701 BackgroundDemo[465:63778] background time remaining:   176.95
2014-10-14 14:20:47.872 BackgroundDemo[465:66674] background time remaining:   176.78
2014-10-14 14:20:48.621 BackgroundDemo[465:63710] 2014-10-14 20:20:48 +0000 locationManager didRangeBeacons
2014-10-14 14:20:48.762 BackgroundDemo[465:63778] background time remaining:   175.89
2014-10-14 14:20:48.915 BackgroundDemo[465:66674] background time remaining:   175.74
2014-10-14 14:20:49.621 BackgroundDemo[465:63710] 2014-10-14 20:20:49 +0000 locationManager didRangeBeacons
2014-10-14 14:20:49.855 BackgroundDemo[465:63778] background time remaining:   174.80
...
```


##Conclusions:

1. It seems you can consistently request extra background time after your app enters the background, providing 180 seconds to keep ranging

2. You can also request extra background time to range when you cross a beacon region, and get the same 180 seconds.

3. You must stop your background task when iOS calls your expirationHandler, otherwise your app will crash when terminated by iOS

##Notes:

1. No background modes need to be requested in the app for this to work, so you probably won't have trouble getting a technique like this approved in the AppStore

2. If your app triggers a beacon region transition while the background task is running, the background time remaining suddenly jumps up to a very large number (max double) for 10 seconds (apparently the normal background ranging time), then starts over at 180 seconds.

3. There are tricks reported that allow you to continue background ranging indefinitely, but I could see these getting you in trouble with the AppStore police:  http://gooddevbaddev.wordpress.com/2013/10/22/ios-7-running-location-based-apps-in-the-background/


